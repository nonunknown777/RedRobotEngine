\doxysection{Job\+System.\+inl}
\hypertarget{JobSystem_8inl_source}{}\label{JobSystem_8inl_source}\index{includes/jolt/Core/JobSystem.inl@{includes/jolt/Core/JobSystem.inl}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Jolt\ Physics\ Library\ (https://github.com/jrouwe/JoltPhysics)}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ SPDX-\/FileCopyrightText:\ 2021\ Jorrit\ Rouwe}}
\DoxyCodeLine{00003\ \textcolor{comment}{//\ SPDX-\/License-\/Identifier:\ MIT}}
\DoxyCodeLine{00004\ }
\DoxyCodeLine{00005\ JPH\_NAMESPACE\_BEGIN}
\DoxyCodeLine{00006\ }
\DoxyCodeLine{00007\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classJobSystem_1_1Job_a7686a4762d0dfe746f0b46edfcae3d6d}{JobSystem::Job::AddDependency}}(\textcolor{keywordtype}{int}\ inCount)}
\DoxyCodeLine{00008\ \{}
\DoxyCodeLine{00009\ \ \ \ \ JPH\_IF\_ENABLE\_ASSERTS(uint32\ old\_value\ =)\ mNumDependencies.fetch\_add(inCount,\ memory\_order\_relaxed);}
\DoxyCodeLine{00010\ \ \ \ \ JPH\_ASSERT(old\_value\ >\ 0\ \&\&\ old\_value\ !=\ \mbox{\hyperlink{classJobSystem_1_1Job_add5d0be4f40149e9b66ebaf3ed99f96b}{cExecutingState}}\ \&\&\ old\_value\ !=\ \mbox{\hyperlink{classJobSystem_1_1Job_aa36ca70b191d31c36707cf642167b926}{cDoneState}},\ \textcolor{stringliteral}{"{}Job\ is\ queued,\ running\ or\ done,\ it\ is\ not\ allowed\ to\ add\ a\ dependency\ to\ a\ running\ job"{}});}
\DoxyCodeLine{00011\ \}}
\DoxyCodeLine{00012\ }
\DoxyCodeLine{00013\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classJobSystem_1_1Job_a59a4638f7edcbfd30f47f096f0f984f1}{JobSystem::Job::RemoveDependency}}(\textcolor{keywordtype}{int}\ inCount)}
\DoxyCodeLine{00014\ \{}
\DoxyCodeLine{00015\ \ \ \ \ uint32\ old\_value\ =\ mNumDependencies.fetch\_sub(inCount,\ memory\_order\_release);}
\DoxyCodeLine{00016\ \ \ \ \ JPH\_ASSERT(old\_value\ !=\ cExecutingState\ \&\&\ old\_value\ !=\ cDoneState,\ \textcolor{stringliteral}{"{}Job\ is\ running\ or\ done,\ it\ is\ not\ allowed\ to\ add\ a\ dependency\ to\ a\ running\ job"{}});}
\DoxyCodeLine{00017\ \ \ \ \ uint32\ new\_value\ =\ old\_value\ -\/\ inCount;}
\DoxyCodeLine{00018\ \ \ \ \ JPH\_ASSERT(old\_value\ >\ new\_value,\ \textcolor{stringliteral}{"{}Test\ wrap\ around,\ this\ is\ a\ logic\ error"{}});}
\DoxyCodeLine{00019\ \ \ \ \ \textcolor{keywordflow}{return}\ new\_value\ ==\ 0;}
\DoxyCodeLine{00020\ \}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classJobSystem_1_1Job_ae4411bbad4af5361b85db233bd0adb43}{JobSystem::Job::RemoveDependencyAndQueue}}(\textcolor{keywordtype}{int}\ inCount)}
\DoxyCodeLine{00023\ \{}
\DoxyCodeLine{00024\ \ \ \ \ \textcolor{keywordflow}{if}\ (RemoveDependency(inCount))}
\DoxyCodeLine{00025\ \ \ \ \ \ \ \ \ mJobSystem-\/>QueueJob(\textcolor{keyword}{this});}
\DoxyCodeLine{00026\ \}}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classJobSystem_1_1JobHandle_a0daface7b509f0f9bd5b03a33554b6c4}{JobSystem::JobHandle::sRemoveDependencies}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classJobSystem_1_1JobHandle}{JobHandle}}\ *inHandles,\ uint\ inNumHandles,\ \textcolor{keywordtype}{int}\ inCount)}
\DoxyCodeLine{00029\ \{}
\DoxyCodeLine{00030\ \ \ \ \ JPH\_PROFILE\_FUNCTION();}
\DoxyCodeLine{00031\ }
\DoxyCodeLine{00032\ \ \ \ \ JPH\_ASSERT(inNumHandles\ >\ 0);}
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00034\ \ \ \ \ \textcolor{comment}{//\ Get\ the\ job\ system,\ all\ jobs\ should\ be\ part\ of\ the\ same\ job\ system}}
\DoxyCodeLine{00035\ \ \ \ \ \mbox{\hyperlink{classJobSystem}{JobSystem}}\ *job\_system\ =\ inHandles-\/>GetPtr()-\/>GetJobSystem();}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ \ \ \ \ \textcolor{comment}{//\ Allocate\ a\ buffer\ to\ store\ the\ jobs\ that\ need\ to\ be\ queued}}
\DoxyCodeLine{00038\ \ \ \ \ \mbox{\hyperlink{classJobSystem_1_1Job}{Job}}\ **jobs\_to\_queue\ =\ (\mbox{\hyperlink{classJobSystem_1_1Job}{Job}}\ **)JPH\_STACK\_ALLOC(inNumHandles\ *\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{classJobSystem_1_1Job}{Job}}\ *));}
\DoxyCodeLine{00039\ \ \ \ \ \mbox{\hyperlink{classJobSystem_1_1Job}{Job}}\ **next\_job\ =\ jobs\_to\_queue;}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \ \ \ \ \textcolor{comment}{//\ Remove\ the\ dependencies\ on\ all\ jobs}}
\DoxyCodeLine{00042\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{const}\ \mbox{\hyperlink{classJobSystem_1_1JobHandle}{JobHandle}}\ *handle\ =\ inHandles,\ *handle\_end\ =\ inHandles\ +\ inNumHandles;\ handle\ <\ handle\_end;\ ++handle)}
\DoxyCodeLine{00043\ \ \ \ \ \{}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classJobSystem_1_1Job}{Job}}\ *job\ =\ handle-\/>GetPtr();}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ JPH\_ASSERT(job-\/>\mbox{\hyperlink{classJobSystem_1_1Job_aa3922bb7442e7e778cec6a8ea984f454}{GetJobSystem}}()\ ==\ job\_system);\ \textcolor{comment}{//\ All\ jobs\ should\ belong\ to\ the\ same\ job\ system}}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (job-\/>\mbox{\hyperlink{classJobSystem_1_1Job_a59a4638f7edcbfd30f47f096f0f984f1}{RemoveDependency}}(inCount))}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \ \ \ \ *(next\_job++)\ =\ job;}
\DoxyCodeLine{00048\ \ \ \ \ \}}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00050\ \ \ \ \ \textcolor{comment}{//\ If\ any\ jobs\ need\ to\ be\ scheduled,\ schedule\ them\ as\ a\ batch}}
\DoxyCodeLine{00051\ \ \ \ \ uint\ num\_jobs\_to\_queue\ =\ uint(next\_job\ -\/\ jobs\_to\_queue);}
\DoxyCodeLine{00052\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_jobs\_to\_queue\ !=\ 0)}
\DoxyCodeLine{00053\ \ \ \ \ \ \ \ \ job\_system-\/>\mbox{\hyperlink{classJobSystem_a5820eef46d040e6ae17e51a828201118}{QueueJobs}}(jobs\_to\_queue,\ num\_jobs\_to\_queue);}
\DoxyCodeLine{00054\ \}}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ JPH\_NAMESPACE\_END}

\end{DoxyCode}
